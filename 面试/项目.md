# 1-熟悉设计秒杀系统

## 1-1-介绍秒杀系统

- 秒杀开始的时候，会有大量用户同时参与进来，因此秒杀系统一定要满足<font color="red">高并发和高性能</font>
- 为了保证秒杀整个流程的顺利执行，整个秒杀系统必须满足<font color="red">高可用</font>
- 由于商品的库存有限，在面对大量订单的情况下，不能超卖，还需要保证<font color="red">一致性</font>

秒杀系统本质是一个高性能、高并发、高可用的三高系统，同时还要保证数据的一致性



## 1-2-如何保证高性能和高并发

### 1-2-1-处理热点数据

正确处理热点数据要做到：

- <font color="red">热点预热</font>（缓存预加载）：提前将秒杀商品的详情、库存等数据缓存到 Redis 中，并设置较长的过期时间。对于页面和抢购的请求都从 Redis 中读取，缓解数据库压力，提高系统性能
- 避免热点数据带来<font color="red">缓存穿透、缓存击穿和缓存雪崩</font>的问题



### 1-2-2-流量削峰

使用消息队列



## 1-3-如何保证高可用

### 1-3-1集群化

想要保证系统中某⼀个组件的⾼可⽤，往往需要搭建集群来避免单点⻛险，⽐如说 Nginx 集群、MySQL 集群、Redis 集群



### 1-3-2-限流

Nginx 限流

GateWay 限流

Sentinel 限流



### 1-3-3-服务熔断和服务降级

使用 alibaba 的 Sentinel



## 1-4-如何保证一致性

### 1-4-1-保证接口幂等性

- <font color="red">概念</font>：同一个请求被重复执行多次，其效果与执行一次相同

- <font color="red">原因</font>：由于网络重试、用户误操作或中间件重复投递等原因，导致资源被重复扣减、订单被重复创建

- <font color="red">做法</font>:

    - 前端：对创建订单的按钮进行“节流”，每隔一定时间执行一次，避免用户短时间多次重复点击按钮

    - 后端：

        - 插入数据的场景，使用数据库的唯一索引，作为兜底方案，适合

        - 唯一请求标识（幂等 Token ）机制
            - 在调用幂等接口前（页面渲染的时候），先通过 UUID，生成一个唯一标识（加上业务前缀），并存入缓存，设置过期时间
            - 前端发送请求后，进行唯一标识的校验（需要使用 Lua 脚本保证 Redis 校验和删除命令的原子性），存在，删除唯一标识并执行业务；不存在，拒接处理



### 1-4-2-扣减库存一致

提交订单后减库存，订单超时未处理，库存恢复

预扣库存







### 1-2-4-超卖问题



### 1-2-5-一人一单